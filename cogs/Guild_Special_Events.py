import discord
import random
from discord.ext import commands
from discord_components import Button, ButtonStyle
from db.players_db import *
from db.special_event import *


class GuildSpecialEventCommand(commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    @commands.Cog.listener()
    async def on_button_click(self, interaction):
        member = interaction.author
        event_btn = interaction.component.custom_id
        check = player_mission(member.id)
        channel_id = get_channel_id(member.id)
        channel_name = interaction.guild.get_channel(channel_id)
        check_img = event_image_upload_status(member.id)
        event_award = get_event_exp(member.id)
        event_coins = get_event_coin(member.id)
        player_exp = players_exp(member.id)
        success = self.bot.get_channel(936149260540461106)
        if event_btn == 'event_1':
            if check == 0:
                coin = 4000
                exp = 10000
                ex_date = '2020-02-15'
                await interaction.respond(content=f'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **{ex_date}**')
                events_recode(member.id, coin, exp, ex_date)
                mission_up(member.id)
            if check == 1:
                await interaction.respond(content='‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
            await interaction.respond(content='‡πÑ‡∏°‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Steam id ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö')

        if event_btn == 'report_event_1':
            expire = expire_date('2022-02-15')
            if expire == 0:
                await interaction.respond(content='‚ö† Mission Expire : ‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö')
            if channel_name is None:
                await interaction.respond(content=f'‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà')
                category = discord.utils.get(interaction.guild.categories, name='EVENT')
                overwrites = {
                    interaction.guild.default_role: discord.PermissionOverwrite(read_messages=False, connect=False),
                    member: discord.PermissionOverwrite(read_messages=True)
                }
                new_channel_name = f'‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©-{players_bank_id(member.id)}'
                await category.edit(overwrites=overwrites)
                await interaction.guild.create_text_channel(new_channel_name, category=category)
                channel = discord.utils.get(interaction.guild.channels, name=str(new_channel_name))
                channel_send = interaction.guild.get_channel(channel.id)
                channel_id_update(member.id, channel.id)
                await channel_send.send(
                    f'{member.mention}\n '
                    f'‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏™‡πà‡∏á‡∏¢‡∏±‡∏á C3N1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á Guild Master ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ '
                    f'‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ï‡∏π‡πâ ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ï‡∏π‡πâ '
                    f'‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (SEND MISSION)‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ',
                    file=discord.File('./img/mission_center.png'),
                    components=[
                        [
                            Button(
                                style=ButtonStyle.blue,
                                label='‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
                                emoji='üì∑',
                                custom_id='event_upload'),
                            Button(
                                style=ButtonStyle.red,
                                label='‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à',
                                emoji='‚ùå',
                                custom_id='event_reset'
                            )
                        ]
                    ]
                )

                await interaction.channel.send(f'‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à <#{channel.id}>', delete_after=10)
            if channel_name is not None:
                await interaction.respond(content=f'‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à <#{channel_id}>')

        if event_btn == 'event_upload':
            if check_img == 0:
                update_image_status(member.id)
                await interaction.respond(content='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏≥‡∏°‡∏≤‡∏™‡πà‡∏á')
                #
                # def check(message):
                #     attachments = message.attachments
                #     if len(attachments) == 0:
                #         return False
                #     attachment = attachments[0]
                #     return attachment.filename.endswith(('.jpg', '.png'))
                #
                # msg = await self.bot.wait_for('message', check=check)
                # if msg is not None:
                #     update_image_status(member.id)
                #     exp = player_exp + event_award
                #     exp_up(member.id, exp)
                #     await interaction.channel.send(
                #         f'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ üéñexp ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {event_award} ‡πÉ‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ\n'
                #         f'‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ')
                # image = msg.attachments[0]
                # embed = discord.Embed(
                #     title=f'‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÇ‡∏î‡∏¢ {member.name}',
                #     description='‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ ',
                #     color=discord.Colour.green()
                # )
                # embed.set_image(url=image)
                # embed.add_field(name='‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à', value=member.mention, inline=False)
                # embed.add_field(name='üí∞ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', value='${:d}'.format(event_coins), inline=True)
                # embed.add_field(name='üéö EXP ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', value=f"{event_award}", inline=True)
                # msg = await success.send(embed=embed)
                # await msg.add_reaction("‚ùî")
            await interaction.respond(content='‚ö† ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ')

        if event_btn == 'detail_event_1':
            await interaction.respond(
                content='**‡∏ô‡∏≥‡∏™‡πà‡∏á‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò‡∏õ‡∏∑‡∏ô SDASS 12M** ‡∏ã‡∏∂‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ '
                        '\n- ‡∏õ‡∏∑‡∏ô SDASS 12M 1 ‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å'
                        '\n- Improvised Flashlight 1 ‡∏≠‡∏±‡∏ô '
                        '\n- OKP-7 Holographic 1 ‡∏≠‡∏±‡∏ô '
                        '\n- Bridshot 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) '
                        '\n- Buckshot 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á (‡∏™‡∏µ‡πÅ‡∏î‡∏á) '
                        '\n- Slug 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á (‡∏™‡∏µ‡∏î‡∏≥) ',
            )

    @commands.command(name='special_event')
    async def special_event_command(self, ctx):
        code = random.randint(9, 99999)
        await ctx.send(
            f'**‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç {code}**'
            f'\n‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• **4000** ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå **10000** exp'
            f'\nMission Expire in 15 February 2022'
        )
        await ctx.send(
            file=discord.File('./img/events/special_event.png'),
            components=[
                [
                    Button(style=ButtonStyle.green, label='‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à', emoji='‚öî', custom_id='event_1'),
                    Button(style=ButtonStyle.blue, label='‡∏™‡πà‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à', emoji='üì©', custom_id='report_event_1'),
                    Button(style=ButtonStyle.gray, label='‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à', emoji='üìÉ', custom_id='detail_event_1')
                ]
            ]
        )


def setup(bot):
    bot.add_cog(GuildSpecialEventCommand(bot))
